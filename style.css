/* ===========================
   Light theme & base
   =========================== */
:root{
  --bg:#fff;
  --panel:#f7f9fb;
  --text:#0b1220;
  --muted:#4b5563;
  --accent:#2563eb;
  --border:#e5e7eb;

  --header-h:58px;               /* actual header height */
}

*{ box-sizing:border-box; }
html, body{ height:100%; }
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
}

/* ===========================
   Header
   =========================== */
header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  background:#ffffffcc; backdrop-filter:blur(6px);
}
h1{ margin:0; font-size:18px; letter-spacing:.2px; }

/* Hide file/sample controls in UI */
.file-controls{ display:none !important; }

/* ===========================
   Inputs
   =========================== */
input[type="text"], input[type="number"]{
  width:100%; padding:8px 10px;
  border:1px solid var(--border); border-radius:8px;
  background:var(--bg); color:var(--text);
}
input[type="range"]{ width:100%; }
code{ background:#eef2f7; padding:2px 4px; border-radius:4px; }

/* ===========================
   Tabs / toolbar
   =========================== */
.tabs{ display:flex; gap:6px; }
.tabs button{
  background:var(--panel);
  border:1px solid var(--border);
  color:var(--text);
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
}
.tabs button[aria-selected="true"]{ outline:2px solid var(--accent); outline-offset:0; }
.tabs.sub{ margin-left:0; }

.toolbar{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
.toolbar .group{ display:flex; align-items:center; gap:10px; }
.vsep{ width:1px; height:30px; background:var(--border); margin:0 6px; }

/* ===========================
   Main grid
   - Row 1: sidebar + top panes
   - Row 2: clustering metrics (full width, page may scroll)
   =========================== */
main{
  display:grid;
  grid-template-columns:320px 1fr;
  grid-template-rows:auto auto;                  /* let the page grow */
  min-height:calc(100vh - var(--header-h));      /* at least viewport */
}

/* Sidebar never dictates row height; it scrolls instead */
#sidebar{
  grid-row:1;
  align-self:stretch;
  max-height:calc(100vh - var(--header-h));      /* stays flush with top row */
  overflow:auto;
  padding:14px;
  border-right:1px solid var(--border);
  background:#fbfdff;
}

.section{ margin-bottom:18px; }
.section h2{ margin:10px 0; font-size:14px; color:var(--muted); }
.checklist{ display:grid; gap:6px; max-height:50vh; overflow:auto; padding-right:4px; }
.chk{ display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:6px; border:1px solid transparent; }
.chk:hover{ background:#f3f6fb; border-color:var(--border); }
.chk .swatch{ width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,.15); }
label.toggle{ display:flex; align-items:center; gap:8px; user-select:none; }

/* ===========================
   Top panes area
   =========================== */
#panes{
  grid-row:1;
  display:grid;
  gap:10px;
  padding:10px;
  grid-auto-rows:minmax(0,auto);
  /* ensure the top row is at least viewport height; page can extend beyond */
  min-height:calc(100vh - var(--header-h));
  overflow:hidden;
}
#panes.single{ grid-template-columns:1fr; }
#panes.dual  { grid-template-columns:1fr 6px 1fr; }

.pane{
  position:relative;
  min-width:0;
  min-height:0;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* UMAP + Accuracy fill their pane */
#plot-umap, #plot-acc{
  flex:1 1 auto;
  min-height:0;
  width:100%;
}

/* Accuracy pane can scroll internally for large K */
#pane-acc{ overflow:auto; -webkit-overflow-scrolling:touch; }

/* Status badges (kept, but youâ€™re hiding them in JS; harmless) */
.panel-status{
  position:absolute; left:10px; bottom:10px;
  background:rgba(255,255,255,.85);
  border:1px solid var(--border); border-radius:6px;
  padding:6px 10px; font-size:12px; color:var(--muted);
}

/* Divider (draggable) */
#divider{
  width:6px; min-width:6px;
  background:linear-gradient(to bottom,#e5e7eb,#d1d5db);
  border-left:1px solid #cbd5e1; border-right:1px solid #cbd5e1;
  border-radius:2px; cursor:col-resize;
}
#divider:hover{ background:linear-gradient(to bottom,#dfe3e8,#cdd6df); }
#divider.dragging{ background:#c9d4e0; }

/* Placeholder when both panes are hidden */
.pane.placeholder{
  display:grid; place-items:center;
  background:#fafcff; border:1px dashed var(--border);
  border-radius:8px; color:var(--muted);
}
.placeholder-inner h3{ margin:0 0 6px; font-weight:600; color:var(--text); }
.placeholder-inner p{ margin:0; }

/* Dim control panels when inactive (visual only) */
#umap-controls.inactive, #acc-controls.inactive{ opacity:.4; }

/* Honor [hidden] always */
[hidden]{ display:none !important; }
.pane[hidden], #divider[hidden], #pane-blank[hidden]{ display:none !important; }

/* ===========================
   Clustering Metrics (full width)
   - lives under the top row; page scrolls if tall
   =========================== */
#metrics{
  grid-row:2; grid-column:1 / -1;
  padding:14px; border-top:1px solid var(--border); background:#fff;
}
#metrics h2{ margin:0 0 10px; font-size:18px; color:var(--text); }

#metrics-grid{
  display:grid;
  grid-template-columns:minmax(520px,2fr) minmax(340px,1fr);
  gap:12px; align-items:start;
}
#metrics-left{ position:relative; }
#metrics-right{ border:1px solid var(--border); border-radius:8px; padding:12px; background:#fbfdff; }
#metrics-plot{ width:100%; height:560px; min-width:0; }
.metric-desc h3{ margin:6px 0 8px; }
.metric-desc p{ margin:6px 0; color:var(--muted); line-height:1.45; }
#metrics.disabled{ opacity:.5; pointer-events:none; }

/* ===========================
   Responsive
   =========================== */
@media (max-width:1100px){
  #metrics-grid{ grid-template-columns:1fr; }
}

/* Optional: keep the status nodes hidden */
#status, #status-umap, #status-acc{ display:none !important; }

/* ===== Composition & NMR Summaries ===== */
#chem{
  grid-column: 1 / -1;
  grid-row: auto;       /* third row under metrics */
  padding: 14px;
  border-top: 1px solid var(--border);
  background: #fff;
}
#chem h2{ margin:0 0 10px; font-size:18px; color:var(--text); }

#chem-grid{
  display: grid;
  grid-template-columns: 320px 1fr;
  gap: 12px;
  align-items: start;
  min-height: 0;
}

#chem-side{
  min-height: 0;
  overflow: auto;
  border-right: 1px solid var(--border);
  padding-right: 12px;
}
#chem-side h3{ margin: 10px 0 6px; font-size: 14px; color: var(--muted); }
#chem-side .muted-note p{ color: var(--muted); font-size: 12px; }

#chem-main{ min-width: 0; }
#chem-plot{ width: 100%; height: 520px; min-width: 0; } /* JS may override height */
#chem-desc{
  margin-top: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  background: #fbfdff;
}
#chem-desc h3{ margin: 6px 0 8px; }
#chem-desc p{ margin: 6px 0; color: var(--muted); line-height: 1.45; }

@media (max-width: 1100px){
  #chem-grid{ grid-template-columns: 1fr; }
  #chem-side{ border-right: none; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
}

/* Make CHEM metric selector vertical */
#chem-tabs{
  display: flex;
  flex-direction: column;   /* stack buttons */
  gap: 8px;
  max-height: 100%;
  overflow: auto;           /* scroll if lots of metrics */
}

#chem-tabs button{
  width: 100%;
  text-align: left;         /* read like a list */
  justify-content: flex-start;
  white-space: normal;      /* allow wrapping for long labels */
  line-height: 1.2;
  padding: 8px 10px;        /* a bit taller for touch */
  font-size: 13px;          /* slightly smaller in the narrow sidebar */
}

.tabs { padding: 4px; overflow: visible; }
.tabs button { margin: 2px; }
.tabs button[aria-selected="true"] { outline-offset: 2px; }
#chem-metric-tabs,
#chem-tabs {                 /* whichever id you're using */
  padding-right: 12px;       /* extra room on the right for the outline */
  overflow: visible;         /* don't clip the outline */
}

/* (optional) keep the selected ring slightly off the button edge */
#chem-metric-tabs button[aria-selected="true"],
#chem-tabs button[aria-selected="true"] {
  outline-offset: 2px;
}

/* Help button (header, right) */
.help-btn{
  padding:8px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--panel);
  cursor:pointer;
}
.help-btn:hover{ border-color:var(--accent); }
.help-btn:focus{ outline:2px solid var(--accent); outline-offset:2px; }

/* Drawer container */
.help-drawer{
  position:fixed;
  top:var(--header-h);
  right:0;
  width:clamp(320px, 34vw, 420px);
  height:calc(100vh - var(--header-h));
  background:#fff;
  border-left:1px solid var(--border);
  box-shadow:-12px 0 24px rgba(0,0,0,.08);
  transform:translateX(100%);
  transition:transform .28s ease;
  z-index:1002;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.help-drawer.open{ transform:translateX(0); }
.help-drawer__header{
  display:flex; align-items:center; gap:8px;
  padding:12px 14px;
  border-bottom:1px solid var(--border);
}
.help-drawer__header h2{
  margin:0; font-size:18px; color:var(--text);
}
.help-close{
  margin-right:auto;
  border:1px solid var(--border);
  background:var(--panel);
  border-radius:8px;
  width:32px; height:32px;
  display:grid; place-items:center;
  cursor:pointer;
}
.help-close:hover{ border-color:var(--accent); }
.help-close:focus{ outline:2px solid var(--accent); outline-offset:2px; }

.help-drawer__body{
  padding:14px;
  overflow:auto;
}
.help-drawer__body h3{ margin:14px 0 6px; }
.help-drawer__body ul{ margin:6px 0 12px 18px; }
.help-drawer__body li{ margin:4px 0; }

/* Dim overlay (below header) */
.help-overlay{
  position:fixed;
  top:var(--header-h);
  left:0; right:0; bottom:0;
  background:rgba(0,0,0,.15);
  z-index:1001;
  opacity:0;
  transition:opacity .25s ease;
}
.help-overlay.open{ opacity:1; }
body.help-open{ overflow:hidden; }  /* optional: prevent background scroll */

/* ===========================
   Confusion Matrix section
   =========================== */
#conf{
  grid-row: auto;
  grid-column: 1 / -1;
  padding: 14px;
  border-top: 1px solid var(--border);
  background: #fff;
}
#conf h2{ margin:0 0 10px; font-size:18px; color:var(--text); }

#conf-grid{
  display:grid;
  grid-template-columns:minmax(520px,2fr) minmax(320px,1fr); /* plot | right sidebar */
  gap:12px;
  align-items:start;
}

#conf-plot{ width:100%; height:640px; min-width:0; }

#conf-right{
  border:1px solid var(--border);
  border-radius:8px;
  padding:12px;
  background:#fbfdff;
  overflow:visible;        /* so focus ring never clips */
}

#conf-right label{
  display:block;
  margin:10px 0;
}

@media (max-width:1100px){
  #conf-grid{ grid-template-columns:1fr; }
}

/* Vertical button tabs (used in #conf-right) */
.tabs.vstack{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.tabs.vstack button{
  width:100%;
  text-align:left;
  padding:8px 12px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:10px;     /* a bit larger to avoid clipped ring */
  cursor:pointer;
}
.tabs.vstack button[aria-selected="true"]{
  outline:2px solid var(--accent);
  outline-offset:2px;     /* keep ring away from edge */
}
#conf-right{ overflow:visible; } /* donâ€™t clip the outline */
